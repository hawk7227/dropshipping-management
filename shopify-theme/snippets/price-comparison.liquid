{% comment %}
  Price Comparison Snippet
  Shows competitor price vs our price with profit/loss indicator
  
  Usage: {% render 'price-comparison', product: product %}
  
  Requires metafields:
  - product.metafields.competitor.price (number)
  - product.metafields.competitor.source (string: "Amazon", "Walmart", etc.)
  - product.metafields.competitor.last_updated (date)
  - product.metafields.inventory.cost (number) - your cost price
{% endcomment %}

{% assign competitor_price = product.metafields.competitor.price | default: 0 %}
{% assign competitor_source = product.metafields.competitor.source | default: "Amazon" %}
{% assign our_price = product.price | divided_by: 100.0 %}
{% assign cost_price = product.metafields.inventory.cost | default: 0 %}

{% if competitor_price > 0 %}
  {% assign savings_amount = competitor_price | minus: our_price %}
  {% assign savings_percent = savings_amount | divided_by: competitor_price | times: 100 | round %}
  
  {% comment %} Calculate profit/loss {% endcomment %}
  {% if cost_price > 0 %}
    {% assign profit_amount = our_price | minus: cost_price %}
    {% assign profit_percent = profit_amount | divided_by: cost_price | times: 100 | round %}
  {% else %}
    {% assign profit_amount = 0 %}
    {% assign profit_percent = 0 %}
  {% endif %}

  <div class="price-comparison" style="margin: 16px 0; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
    
    {% comment %} Price Display {% endcomment %}
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
      
      {% comment %} Competitor Price (Struck Through) {% endcomment %}
      <div style="text-align: center;">
        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">{{ competitor_source }} Price</div>
        <div style="font-size: 18px; color: #9ca3af; text-decoration: line-through;">
          {{ competitor_price | money }}
        </div>
      </div>
      
      {% comment %} Arrow {% endcomment %}
      <div style="font-size: 24px; color: #10b981;">â†’</div>
      
      {% comment %} Our Price {% endcomment %}
      <div style="text-align: center;">
        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Our Price</div>
        <div style="font-size: 24px; font-weight: 700; color: #111;">
          {{ our_price | money }}
        </div>
      </div>
      
      {% comment %} Savings Badge {% endcomment %}
      {% if savings_percent > 0 %}
        <div style="background: #10b981; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
          SAVE {{ savings_percent }}%
        </div>
      {% elsif savings_percent < 0 %}
        <div style="background: #ef4444; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
          {{ savings_percent | abs }}% MORE
        </div>
      {% endif %}
    </div>
    
    {% comment %} Savings Amount {% endcomment %}
    {% if savings_amount > 0 %}
      <div style="margin-top: 12px; text-align: center; font-size: 14px; color: #059669;">
        You save <strong>{{ savings_amount | money }}</strong> compared to {{ competitor_source }}!
      </div>
    {% endif %}
    
    {% comment %} Profit/Loss Indicator (Admin only - hidden by default, enable via CSS class) {% endcomment %}
    {% if cost_price > 0 %}
      <div class="profit-indicator" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
        <div style="display: flex; justify-content: space-between; font-size: 13px;">
          <span style="color: #6b7280;">Cost: {{ cost_price | money }}</span>
          <span style="{% if profit_percent > 0 %}color: #059669;{% elsif profit_percent < 0 %}color: #dc2626;{% else %}color: #6b7280;{% endif %} font-weight: 600;">
            {% if profit_percent > 0 %}
              Profit: +{{ profit_percent }}% ({{ profit_amount | money }})
            {% elsif profit_percent < 0 %}
              Loss: {{ profit_percent }}% ({{ profit_amount | money }})
            {% else %}
              Break Even
            {% endif %}
          </span>
        </div>
      </div>
    {% endif %}
    
    {% comment %} Last Updated {% endcomment %}
    {% assign last_updated = product.metafields.competitor.last_updated %}
    {% if last_updated %}
      <div style="margin-top: 8px; font-size: 11px; color: #9ca3af; text-align: right;">
        Price checked: {{ last_updated | date: "%b %d, %Y at %I:%M %p" }}
      </div>
    {% endif %}
  </div>
{% endif %}

<style>
  /* Show profit indicator for logged-in admins */
  .shopify-admin .profit-indicator,
  .customer-admin .profit-indicator {
    display: block !important;
  }
  
  @media (max-width: 480px) {
    .price-comparison {
      padding: 12px !important;
    }
    .price-comparison > div:first-child {
      flex-direction: column;
    }
  }
</style>
