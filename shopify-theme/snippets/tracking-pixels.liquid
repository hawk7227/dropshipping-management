{% comment %}
  tracking-pixels.liquid — Spec Item 41
  Retargeting pixel deployment for Shopify theme
  
  Usage in theme.liquid <head>:
    {% render 'tracking-pixels' %}
  
  For AddToCart events:
    {% render 'tracking-pixels', event: 'add_to_cart', product: product, variant: variant %}
  
  For Purchase events (thank-you page):
    {% render 'tracking-pixels', event: 'purchase', order: order %}
  
  Pixel IDs from theme settings:
    settings.fb_pixel_id
    settings.tiktok_pixel_id
    settings.pinterest_tag_id
    settings.ga4_measurement_id
{% endcomment %}

{% comment %} ═══ Facebook Pixel ═══ {% endcomment %}
{% if settings.fb_pixel_id and settings.fb_pixel_id != blank %}
  {% unless event %}
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '{{ settings.fb_pixel_id }}');
      fbq('track', 'PageView');
      {% if template contains 'product' and product %}
        fbq('track', 'ViewContent', {
          content_ids: [{{ product.selected_or_first_available_variant.id | json }}],
          content_name: {{ product.title | json }},
          content_type: 'product',
          value: {{ product.price | divided_by: 100.0 }},
          currency: '{{ shop.currency }}'
        });
      {% endif %}
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id={{ settings.fb_pixel_id }}&ev=PageView&noscript=1" alt="" /></noscript>
  {% endunless %}

  {% if event == 'add_to_cart' and product %}
    <script>
      if(typeof fbq!=='undefined'){fbq('track','AddToCart',{
        content_ids:[{{ variant.id | default: product.selected_or_first_available_variant.id | json }}],
        content_name:{{ product.title | json }},content_type:'product',
        value:{{ product.price | divided_by: 100.0 }},currency:'{{ shop.currency }}'
      });}
    </script>
  {% endif %}

  {% if event == 'purchase' and order %}
    <script>
      if(typeof fbq!=='undefined'){fbq('track','Purchase',{
        value:{{ order.total_price | divided_by: 100.0 }},currency:'{{ order.currency }}',
        content_ids:[{% for item in order.line_items %}{{ item.variant_id | json }}{% unless forloop.last %},{% endunless %}{% endfor %}],
        content_type:'product',num_items:{{ order.line_items.size }}
      });}
    </script>
  {% endif %}
{% endif %}

{% comment %} ═══ TikTok Pixel ═══ {% endcomment %}
{% if settings.tiktok_pixel_id and settings.tiktok_pixel_id != blank %}
  {% unless event %}
    <script>
      !function(w,d,t){w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];
      ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"];
      ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0))) }; };
      for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
      ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e};
      ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";
      ttq._i=ttq._i||{};ttq._i[e]=[];ttq._i[e]._u=i;ttq._t=ttq._t||{};ttq._t[e]=+new Date;
      ttq._o=ttq._o||{};ttq._o[e]=n||{};var o=document.createElement("script");
      o.type="text/javascript";o.async=!0;o.src=i+"?sdkid="+e+"&lib="+t;
      var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};
      ttq.load('{{ settings.tiktok_pixel_id }}');
      ttq.page();
      {% if template contains 'product' and product %}
        ttq.track('ViewContent',{
          content_id:{{ product.selected_or_first_available_variant.id | json }},
          content_name:{{ product.title | json }},content_type:'product',
          price:{{ product.price | divided_by: 100.0 }},currency:'{{ shop.currency }}'
        });
      {% endif %}
    </script>
  {% endunless %}

  {% if event == 'add_to_cart' and product %}
    <script>
      if(typeof ttq!=='undefined'){ttq.track('AddToCart',{
        content_id:{{ variant.id | default: product.selected_or_first_available_variant.id | json }},
        content_name:{{ product.title | json }},content_type:'product',
        price:{{ product.price | divided_by: 100.0 }},currency:'{{ shop.currency }}'
      });}
    </script>
  {% endif %}

  {% if event == 'purchase' and order %}
    <script>
      if(typeof ttq!=='undefined'){ttq.track('PlaceAnOrder',{
        value:{{ order.total_price | divided_by: 100.0 }},currency:'{{ order.currency }}',
        contents:[{% for item in order.line_items %}{content_id:{{ item.variant_id | json }},quantity:{{ item.quantity }},price:{{ item.price | divided_by: 100.0 }}}{% unless forloop.last %},{% endunless %}{% endfor %}]
      });}
    </script>
  {% endif %}
{% endif %}

{% comment %} ═══ Pinterest Tag ═══ {% endcomment %}
{% if settings.pinterest_tag_id and settings.pinterest_tag_id != blank %}
  {% unless event %}
    <script>
      !function(e){if(!window.pintrk){window.pintrk=function(){window.pintrk.queue.push(Array.prototype.slice.call(arguments))};
      var n=window.pintrk;n.queue=[],n.version="3.0";
      var t=document.createElement("script");t.async=!0,t.src=e;
      var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(t,r); } }
      ("https://s.pinimg.com/ct/core.js");
      pintrk('load','{{ settings.pinterest_tag_id }}');
      pintrk('page');
      {% if template contains 'product' and product %}
        pintrk('track','pagevisit',{
          product_id:{{ product.selected_or_first_available_variant.id | json }},
          product_name:{{ product.title | json }},
          product_price:{{ product.price | divided_by: 100.0 }},
          product_currency:'{{ shop.currency }}'
        });
      {% endif %}
    </script>
    <noscript><img height="1" width="1" style="display:none;" alt="" src="https://ct.pinterest.com/v3/?event=init&tid={{ settings.pinterest_tag_id }}&noscript=1" /></noscript>
  {% endunless %}

  {% if event == 'add_to_cart' and product %}
    <script>
      if(typeof pintrk!=='undefined'){pintrk('track','addtocart',{
        product_id:{{ variant.id | default: product.selected_or_first_available_variant.id | json }},
        product_name:{{ product.title | json }},
        product_price:{{ product.price | divided_by: 100.0 }},
        product_currency:'{{ shop.currency }}'
      });}
    </script>
  {% endif %}

  {% if event == 'purchase' and order %}
    <script>
      if(typeof pintrk!=='undefined'){pintrk('track','checkout',{
        value:{{ order.total_price | divided_by: 100.0 }},currency:'{{ order.currency }}',
        order_quantity:{{ order.line_items.size }},
        line_items:[{% for item in order.line_items %}{product_id:{{ item.variant_id | json }},product_quantity:{{ item.quantity }},product_price:{{ item.price | divided_by: 100.0 }}}{% unless forloop.last %},{% endunless %}{% endfor %}]
      });}
    </script>
  {% endif %}
{% endif %}

{% comment %} ═══ Google Analytics 4 ═══ {% endcomment %}
{% if settings.ga4_measurement_id and settings.ga4_measurement_id != blank %}
  {% unless event %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ settings.ga4_measurement_id }}"></script>
    <script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
      gtag('js',new Date());gtag('config','{{ settings.ga4_measurement_id }}');
      {% if template contains 'product' and product %}
        gtag('event','view_item',{
          currency:'{{ shop.currency }}',value:{{ product.price | divided_by: 100.0 }},
          items:[{item_id:{{ product.selected_or_first_available_variant.id | json }},
            item_name:{{ product.title | json }},price:{{ product.price | divided_by: 100.0 }},
            item_brand:{{ product.vendor | json }},item_category:{{ product.type | json }},quantity:1}]
        });
      {% endif %}
    </script>
  {% endunless %}

  {% if event == 'add_to_cart' and product %}
    <script>
      if(typeof gtag!=='undefined'){gtag('event','add_to_cart',{
        currency:'{{ shop.currency }}',value:{{ product.price | divided_by: 100.0 }},
        items:[{item_id:{{ variant.id | default: product.selected_or_first_available_variant.id | json }},
          item_name:{{ product.title | json }},price:{{ product.price | divided_by: 100.0 }},quantity:1}]
      });}
    </script>
  {% endif %}

  {% if event == 'purchase' and order %}
    <script>
      if(typeof gtag!=='undefined'){gtag('event','purchase',{
        transaction_id:{{ order.order_number | json }},
        value:{{ order.total_price | divided_by: 100.0 }},currency:'{{ order.currency }}',
        items:[{% for item in order.line_items %}{item_id:{{ item.variant_id | json }},
          item_name:{{ item.title | json }},price:{{ item.price | divided_by: 100.0 }},
          quantity:{{ item.quantity }}}{% unless forloop.last %},{% endunless %}{% endfor %}]
      });}
    </script>
  {% endif %}
{% endif %}
