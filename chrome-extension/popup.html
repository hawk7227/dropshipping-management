<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { width: 380px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d0d12; color: #e4e4e7; font-size: 13px; }
    .header { padding: 16px; background: linear-gradient(135deg, #06b6d4 0%, #a855f7 100%); text-align: center; }
    .header h1 { font-size: 16px; font-weight: 700; color: white; }
    .header p { font-size: 10px; color: rgba(255,255,255,0.7); margin-top: 4px; }

    /* HEALTH BANNER */
    .health-banner { padding: 10px 14px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.2s; }
    .health-banner:hover { filter: brightness(1.1); }
    .health-banner.ok { background: #14532d; }
    .health-banner.warn { background: #713f12; }
    .health-banner.error { background: #7f1d1d; }
    .health-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .health-banner.ok .health-dot { background: #4ade80; box-shadow: 0 0 6px #4ade80; }
    .health-banner.warn .health-dot { background: #fbbf24; box-shadow: 0 0 6px #fbbf24; animation: pulse 1.5s infinite; }
    .health-banner.error .health-dot { background: #f87171; box-shadow: 0 0 6px #f87171; animation: pulse 0.8s infinite; }
    .health-text { flex: 1; }
    .health-text .title { font-size: 12px; font-weight: 600; }
    .health-text .subtitle { font-size: 9px; color: rgba(255,255,255,0.6); margin-top: 2px; }
    .health-arrow { color: rgba(255,255,255,0.4); font-size: 14px; }

    /* ALERT MODAL */
    .alert-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; overflow-y: auto; padding: 20px; }
    .alert-overlay.visible { display: block; }
    .alert-box { background: #1a1a24; border: 1px solid #27272a; border-radius: 14px; padding: 20px; max-width: 340px; margin: 0 auto; }
    .alert-box .close-btn { float: right; background: none; border: none; color: #71717a; font-size: 18px; cursor: pointer; padding: 0 4px; }
    .alert-box .close-btn:hover { color: white; }
    .alert-box h2 { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .alert-box h2 .icon { font-size: 20px; }
    .alert-item { padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid; }
    .alert-item.error { background: #7f1d1d20; border-color: #f8717140; }
    .alert-item.warn { background: #713f1220; border-color: #fbbf2440; }
    .alert-item.ok { background: #14532d20; border-color: #4ade8040; }
    .alert-item .platform-name { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
    .alert-item .status-badge { font-size: 9px; padding: 2px 8px; border-radius: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .alert-item .status-badge.ok { background: #4ade8030; color: #4ade80; }
    .alert-item .status-badge.error { background: #f8717130; color: #f87171; }
    .alert-item .status-badge.warn { background: #fbbf2430; color: #fbbf24; }
    .alert-item .status-badge.unknown { background: #71717a30; color: #71717a; }
    .alert-item .issue { font-size: 11px; color: #fbbf24; margin-bottom: 6px; }
    .alert-item .fix { font-size: 10px; color: #a1a1aa; line-height: 1.5; }
    .alert-item .fix strong { color: #e4e4e7; }
    .alert-item .fix code { background: #0d0d12; padding: 1px 5px; border-radius: 4px; font-size: 9px; color: #06b6d4; }
    .api-status { padding: 10px 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid; font-size: 11px; }
    .api-status.ok { background: #14532d20; border-color: #4ade8040; color: #4ade80; }
    .api-status.error { background: #7f1d1d20; border-color: #f8717140; color: #f87171; }
    .api-status .fix { font-size: 10px; color: #a1a1aa; margin-top: 4px; }
    .recheck-btn { width: 100%; padding: 10px; background: linear-gradient(135deg, #06b6d4, #a855f7); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .recheck-btn:hover { opacity: 0.9; }

    /* STATS BAR */
    .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: #12121a; }
    .stat { text-align: center; padding: 8px 4px; background: #1a1a24; border-radius: 8px; }
    .stat .num { font-size: 18px; font-weight: 700; color: white; }
    .stat .label { font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: #71717a; margin-top: 2px; }
    .stat.green .num { color: #4ade80; }
    .stat.red .num { color: #f87171; }
    .stat.purple .num { color: #a855f7; }
    .stat.cyan .num { color: #06b6d4; }

    /* PLATFORMS */
    .platforms { padding: 12px; }
    .platform-row { display: flex; align-items: center; gap: 10px; padding: 10px; margin-bottom: 8px; background: #12121a; border: 1px solid #27272a; border-radius: 10px; transition: border-color 0.2s; }
    .platform-row.scanning { border-color: #06b6d4; }
    .platform-row.error { border-color: #f87171; }
    .platform-row.warn { border-color: #fbbf24; }
    .platform-row .icon { font-size: 24px; flex-shrink: 0; position: relative; }
    .platform-row .health-pip { position: absolute; bottom: -2px; right: -2px; width: 8px; height: 8px; border-radius: 50%; border: 1.5px solid #12121a; }
    .platform-row .health-pip.ok { background: #4ade80; }
    .platform-row .health-pip.error { background: #f87171; }
    .platform-row .health-pip.warn { background: #fbbf24; }
    .platform-row .health-pip.unknown { background: #71717a; }
    .platform-row .info { flex: 1; }
    .platform-row .name { font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; }
    .platform-row .meta { font-size: 10px; color: #71717a; margin-top: 2px; }
    .platform-row .meta span { margin-right: 8px; }
    .platform-row .meta .friend { color: #4ade80; }
    .platform-row .meta .skipped { color: #f87171; }
    .platform-row .error-hint { font-size: 9px; color: #f87171; margin-top: 3px; display: flex; align-items: center; gap: 4px; }
    .scan-btn { padding: 6px 14px; border: none; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
    .scan-btn.start { background: linear-gradient(135deg, #06b6d4, #a855f7); color: white; }
    .scan-btn.stop { background: #f87171; color: white; }
    .scan-btn:hover { opacity: 0.85; }
    .scan-all { display: block; width: calc(100% - 24px); margin: 0 12px 12px; padding: 12px; background: linear-gradient(135deg, #06b6d4, #a855f7); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; }
    .scan-all:hover { opacity: 0.9; }

    .config-section { padding: 0 12px 12px; }
    .config-input { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: #12121a; border: 1px solid #27272a; border-radius: 8px; margin-bottom: 6px; }
    .config-input label { font-size: 11px; color: #a1a1aa; flex: 1; }
    .config-input input { width: 80px; padding: 4px 8px; background: #0d0d12; border: 1px solid #27272a; border-radius: 6px; color: white; font-size: 11px; text-align: center; }
    .footer { padding: 10px 12px; background: #12121a; border-top: 1px solid #27272a; font-size: 10px; color: #71717a; text-align: center; }
    .footer a { color: #a855f7; text-decoration: none; }
    .scanning-indicator { display: inline-block; width: 6px; height: 6px; background: #4ade80; border-radius: 50%; animation: pulse 1s infinite; margin-right: 4px; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>üß† Social Intelligence Scanner</h1>
    <p>AI-powered friend feed analysis</p>
  </div>

  <!-- HEALTH BANNER ‚Äî click to open detail modal -->
  <div class="health-banner ok" id="healthBanner">
    <div class="health-dot"></div>
    <div class="health-text">
      <div class="title" id="healthTitle">Checking system health...</div>
      <div class="subtitle" id="healthSubtitle">Click for details</div>
    </div>
    <span class="health-arrow">‚Ä∫</span>
  </div>

  <!-- ALERT MODAL -->
  <div class="alert-overlay" id="alertOverlay">
    <div class="alert-box">
      <button class="close-btn" id="alertClose">‚úï</button>
      <h2><span class="icon">üîç</span> System Health</h2>
      
      <!-- API Status -->
      <div class="api-status ok" id="apiStatus">
        <strong>API Connection:</strong> <span id="apiStatusText">Checking...</span>
        <div class="fix" id="apiFix" style="display:none;"></div>
      </div>
      
      <!-- Per-platform health -->
      <div id="platformHealthList"></div>
      
      <button class="recheck-btn" id="recheckBtn">üîÑ Re-check Everything</button>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat green"><div class="num" id="friendCount">0</div><div class="label">Friends</div></div>
    <div class="stat red"><div class="num" id="adCount">0</div><div class="label">Ads Skip</div></div>
    <div class="stat purple"><div class="num" id="sugCount">0</div><div class="label">Sug Skip</div></div>
    <div class="stat cyan"><div class="num" id="totalCount">0</div><div class="label">Total</div></div>
  </div>

  <div class="platforms" id="platformList"></div>
  <button class="scan-all" id="scanAllBtn">üöÄ Scan All Platforms</button>

  <div class="config-section">
    <div class="config-input"><label>API Endpoint</label><input type="text" id="apiBase" value="http://localhost:3000" style="width: 160px;"></div>
    <div class="config-input"><label>Posts per scan</label><input type="number" id="maxPosts" value="100" min="10" max="500"></div>
    <div class="config-input"><label>Auto-scan every (hours)</label><input type="number" id="autoInterval" value="6" min="1" max="24"></div>
  </div>

  <div class="footer">Data flows to <a href="#" id="dashLink">your dashboard</a> ¬∑ <span id="lastScan">No scans yet</span></div>

  <script>
    const platforms = [
      { id: 'instagram', name: 'Instagram', icon: 'üì∏', url: 'instagram.com', file: 'scrapers/instagram.js' },
      { id: 'facebook', name: 'Facebook', icon: 'üìò', url: 'facebook.com', file: 'scrapers/facebook.js' },
      { id: 'tiktok', name: 'TikTok', icon: 'üéµ', url: 'tiktok.com', file: 'scrapers/tiktok.js' },
      { id: 'twitter', name: 'X (Twitter)', icon: 'ùïè', url: 'x.com', file: 'scrapers/twitter.js' },
    ];

    let currentStats = {};
    let currentHealth = {};

    // ============================================================
    // HEALTH BANNER
    // ============================================================
    function updateHealthBanner(health) {
      const banner = document.getElementById('healthBanner');
      const title = document.getElementById('healthTitle');
      const subtitle = document.getElementById('healthSubtitle');

      const issues = [];
      const warnings = [];

      // Check API
      if (health.api && health.api.ok === false) issues.push('API unreachable');
      else if (health.api && health.api.ok === null) warnings.push('API not checked yet');

      // Check platforms
      platforms.forEach(p => {
        const h = health[p.id];
        if (!h) return;
        if (h.ok === false) {
          if (h.error && h.error.startsWith('NOT_LOGGED_IN')) issues.push(`Not logged into ${p.name}`);
          else if (h.error && h.error.startsWith('SELECTORS_BROKEN')) issues.push(`${p.name} scraper broken`);
          else issues.push(`${p.name} issue`);
        }
        else if (h.ok === null && h.loggedIn === null) warnings.push(`${p.name} not checked`);
      });

      if (issues.length > 0) {
        banner.className = 'health-banner error';
        title.textContent = `${issues.length} issue${issues.length > 1 ? 's' : ''} need attention`;
        subtitle.textContent = issues.join(' ¬∑ ');
      } else if (warnings.length > 0) {
        banner.className = 'health-banner warn';
        title.textContent = 'System ready ‚Äî some items unchecked';
        subtitle.textContent = 'Run a scan to verify all platforms';
      } else {
        banner.className = 'health-banner ok';
        title.textContent = 'All systems operational';
        subtitle.textContent = 'API connected ¬∑ All scrapers working ¬∑ All platforms logged in';
      }
    }

    // ============================================================
    // ALERT MODAL ‚Äî detailed health per platform
    // ============================================================
    function renderHealthModal(health) {
      // API status
      const apiDiv = document.getElementById('apiStatus');
      const apiText = document.getElementById('apiStatusText');
      const apiFix = document.getElementById('apiFix');

      if (health.api?.ok === true) {
        apiDiv.className = 'api-status ok';
        apiText.textContent = '‚úÖ Connected';
        apiFix.style.display = 'none';
      } else if (health.api?.ok === false) {
        apiDiv.className = 'api-status error';
        apiText.textContent = '‚ùå Unreachable';
        apiFix.style.display = 'block';
        apiFix.innerHTML = `<strong>Problem:</strong> ${health.api.error || 'Cannot connect'}<br><br>
          <strong>Fix:</strong><br>
          1. Make sure your app is running (<code>npm run dev</code>)<br>
          2. Check the API endpoint URL below matches your app<br>
          3. If deployed, use your Vercel URL instead of localhost`;
      } else {
        apiDiv.className = 'api-status warn';
        apiText.textContent = '‚è≥ Not checked yet';
        apiFix.style.display = 'none';
      }

      // Per-platform
      const list = document.getElementById('platformHealthList');
      list.innerHTML = platforms.map(p => {
        const h = health[p.id] || {};
        const hasIssue = h.ok === false;
        const isUnknown = h.ok === null;
        const statusClass = hasIssue ? 'error' : isUnknown ? 'warn' : 'ok';
        const badgeClass = hasIssue ? 'error' : isUnknown ? 'unknown' : 'ok';
        const badgeText = hasIssue ? 'ISSUE' : isUnknown ? 'UNCHECKED' : 'OK';

        let issueHtml = '';
        let fixHtml = '';

        if (h.error && h.error.startsWith('NOT_LOGGED_IN')) {
          issueHtml = `‚ö†Ô∏è Not logged in`;
          fixHtml = `<strong>Fix:</strong><br>
            1. Open <strong>${p.url}</strong> in a Chrome tab<br>
            2. Log in with your account<br>
            3. Come back here and click <strong>"Re-check Everything"</strong>`;
        } else if (h.error && h.error.startsWith('SELECTORS_BROKEN')) {
          issueHtml = `‚ö†Ô∏è Scraper stopped finding posts`;
          fixHtml = `<strong>What happened:</strong> ${p.name} changed their page layout. The CSS selectors in the scraper no longer match.<br><br>
            <strong>How to fix:</strong><br>
            1. Open <strong>${p.url}</strong> in Chrome<br>
            2. Right-click any post ‚Üí <strong>Inspect</strong><br>
            3. Look at the HTML structure of a post (article tags, username elements, caption containers)<br>
            4. Open <code>${p.file}</code> in your code editor<br>
            5. Update the selectors in the <code>SELECTORS</code> object or <code>extractPost()</code> function to match the new HTML<br>
            6. Reload the extension at <code>chrome://extensions</code> ‚Üí click the üîÑ icon<br>
            7. Try scanning again`;
        } else if (isUnknown) {
          issueHtml = '';
          fixHtml = `Run a scan to check if ${p.name} is working properly.`;
        }

        // Login & scraper status pills
        const loginPill = h.loggedIn === true ? '<span style="color:#4ade80;font-size:9px;">‚úì logged in</span>' :
                          h.loggedIn === false ? '<span style="color:#f87171;font-size:9px;">‚úó not logged in</span>' :
                          '<span style="color:#71717a;font-size:9px;">? login unknown</span>';
        const scraperPill = h.scraperWorking === true ? '<span style="color:#4ade80;font-size:9px;">‚úì scraper ok</span>' :
                            h.scraperWorking === false ? '<span style="color:#f87171;font-size:9px;">‚úó scraper broken</span>' :
                            '<span style="color:#71717a;font-size:9px;">? not tested</span>';
        const lastScanPill = h.lastScan ? `<span style="color:#71717a;font-size:9px;">Last scan: ${timeAgo(h.lastScan)}</span>` : '';

        return `
          <div class="alert-item ${statusClass}">
            <div class="platform-name">
              ${p.icon} ${p.name}
              <span class="status-badge ${badgeClass}">${badgeText}</span>
            </div>
            <div style="display:flex;gap:10px;margin-bottom:6px;">${loginPill} ${scraperPill} ${lastScanPill}</div>
            ${issueHtml ? `<div class="issue">${issueHtml}</div>` : ''}
            ${fixHtml ? `<div class="fix">${fixHtml}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function timeAgo(iso) {
      const diff = Date.now() - new Date(iso).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      return `${Math.floor(hrs / 24)}d ago`;
    }

    // ============================================================
    // PLATFORM ROWS ‚Äî with health indicator pips
    // ============================================================
    function renderPlatforms() {
      const container = document.getElementById('platformList');
      container.innerHTML = platforms.map(p => {
        const stats = currentStats[p.id] || {};
        const health = currentHealth[p.id] || {};
        const isScanning = stats.scanning || false;
        const hasError = health.ok === false;
        const isWarn = health.ok === null;
        const healthPipClass = hasError ? 'error' : isWarn ? 'unknown' : 'ok';
        const rowClass = isScanning ? 'scanning' : hasError ? 'error' : isWarn && !isScanning ? '' : '';

        let errorHint = '';
        if (health.error && health.error.startsWith('NOT_LOGGED_IN')) {
          errorHint = '‚ö†Ô∏è Not logged in ‚Äî click health banner above';
        } else if (health.error && health.error.startsWith('SELECTORS_BROKEN')) {
          errorHint = '‚ö†Ô∏è Scraper broken ‚Äî click health banner for fix';
        }

        return `
          <div class="platform-row ${rowClass}" id="row-${p.id}">
            <span class="icon">${p.icon}<span class="health-pip ${healthPipClass}"></span></span>
            <div class="info">
              <div class="name">${isScanning ? '<span class="scanning-indicator"></span>' : ''}${p.name}</div>
              <div class="meta">
                <span class="friend">üë• ${stats.friendPosts || 0}</span>
                <span class="skipped">üö´ ${(stats.adsSkipped || 0) + (stats.suggestionsSkipped || 0)} skipped</span>
                <span>${stats.total || 0} scanned</span>
              </div>
              ${errorHint ? `<div class="error-hint">${errorHint}</div>` : ''}
            </div>
            <button class="scan-btn ${isScanning ? 'stop' : 'start'}" data-platform="${p.id}">
              ${isScanning ? '‚èπ Stop' : '‚ñ∂ Scan'}
            </button>
          </div>
        `;
      }).join('');

      container.querySelectorAll('.scan-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const platform = btn.dataset.platform;
          const isScanning = currentStats[platform]?.scanning;
          chrome.runtime.sendMessage({ type: isScanning ? 'STOP_SCAN' : 'START_SCAN', platform });
          if (!currentStats[platform]) currentStats[platform] = {};
          currentStats[platform].scanning = !isScanning;
          renderPlatforms();
        });
      });
    }

    function updateGlobalStats() {
      let friends = 0, ads = 0, suggestions = 0, total = 0;
      Object.values(currentStats).forEach(s => {
        friends += s.friendPosts || 0;
        ads += s.adsSkipped || 0;
        suggestions += s.suggestionsSkipped || 0;
        total += s.total || 0;
      });
      document.getElementById('friendCount').textContent = friends;
      document.getElementById('adCount').textContent = ads;
      document.getElementById('sugCount').textContent = suggestions;
      document.getElementById('totalCount').textContent = total;
    }

    // ============================================================
    // EVENT HANDLERS
    // ============================================================
    document.getElementById('healthBanner').addEventListener('click', () => {
      renderHealthModal(currentHealth);
      document.getElementById('alertOverlay').classList.add('visible');
    });

    document.getElementById('alertClose').addEventListener('click', () => {
      document.getElementById('alertOverlay').classList.remove('visible');
    });

    document.getElementById('recheckBtn').addEventListener('click', () => {
      document.getElementById('recheckBtn').textContent = '‚è≥ Checking...';
      chrome.runtime.sendMessage({ type: 'CHECK_API' }, (response) => {
        if (response?.health) {
          currentHealth = response.health;
          updateHealthBanner(currentHealth);
          renderHealthModal(currentHealth);
          renderPlatforms();
        }
        document.getElementById('recheckBtn').textContent = 'üîÑ Re-check Everything';
      });
    });

    document.getElementById('scanAllBtn').addEventListener('click', () => {
      platforms.forEach((p, i) => {
        setTimeout(() => {
          chrome.runtime.sendMessage({ type: 'START_SCAN', platform: p.id });
          if (!currentStats[p.id]) currentStats[p.id] = {};
          currentStats[p.id].scanning = true;
          renderPlatforms();
        }, i * 5000);
      });
    });

    ['apiBase', 'maxPosts', 'autoInterval'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        chrome.storage.local.set({
          apiBase: document.getElementById('apiBase').value,
          maxPosts: parseInt(document.getElementById('maxPosts').value),
          autoInterval: parseInt(document.getElementById('autoInterval').value),
        });
      });
    });

    document.getElementById('dashLink').addEventListener('click', (e) => {
      e.preventDefault();
      chrome.tabs.create({ url: `${document.getElementById('apiBase').value}/social` });
    });

    // ============================================================
    // POLLING
    // ============================================================
    function refreshStats() {
      chrome.runtime.sendMessage({ type: 'GET_STATS' }, (response) => {
        if (response) {
          if (response.stats) { currentStats = response.stats; renderPlatforms(); updateGlobalStats(); }
          if (response.health) { currentHealth = response.health; updateHealthBanner(response.health); }
        }
      });
    }

    chrome.storage.local.get(['apiBase', 'maxPosts', 'autoInterval'], (data) => {
      if (data.apiBase) document.getElementById('apiBase').value = data.apiBase;
      if (data.maxPosts) document.getElementById('maxPosts').value = data.maxPosts;
      if (data.autoInterval) document.getElementById('autoInterval').value = data.autoInterval;
    });

    // Initial API health check + stats
    chrome.runtime.sendMessage({ type: 'CHECK_API' }, (response) => {
      if (response?.health) { currentHealth = response.health; updateHealthBanner(response.health); }
    });
    refreshStats();
    setInterval(refreshStats, 2000);
  </script>
</body>
</html>
